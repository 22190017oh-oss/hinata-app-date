<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>â˜€ï¸ã²ãªãŸã¼ã£ã“â˜€ï¸ â€” ãƒ•ãƒ«ãƒ‡ãƒ¢</title>
<style>
  :root{--accent:#ff8c00;--bg:#fffbe6;}
  body{font-family: "Hiragino Kaku Gothic ProN","Meiryo",sans-serif;background:var(--bg);margin:12px;color:#333;}
  h1,h2{color:var(--accent);margin:0 0 8px 0;}
  .section{background:#fff8e1;border:1px solid #ffd700;padding:12px;border-radius:10px;margin-bottom:12px;}
  .two-col{display:flex;gap:12px;flex-wrap:wrap;}
  .col{flex:1;min-width:260px;}
  input[type=text],input[type=password],input[type=number],select,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;margin-top:6px;box-sizing:border-box;}
  button.btn{background:var(--accent);color:white;border:none;padding:10px;border-radius:8px;cursor:pointer;}
  .profile-card{background:white;border:1px solid #ffd59a;padding:8px;border-radius:8px;margin-bottom:8px;}
  .small{font-size:13px;color:#666;margin-top:6px;}
  .sun{font-size:22px;cursor:pointer;margin-right:6px;user-select:none;}
  #chat{background:#fffde7;border:1px solid #ffd59a;padding:8px;height:180px;overflow:auto;border-radius:8px;}
  .match-popup{position:fixed;left:50%;top:20%;transform:translateX(-50%);background:white;padding:16px;border-radius:10px;border:2px solid var(--accent);z-index:999;animation:pop 600ms ease;}
  @keyframes pop{0%{transform:translateX(-50%) scale(.6);opacity:0}60%{transform:translateX(-50%) scale(1.08);opacity:1}100%{transform:translateX(-50%) scale(1)}}
  .avatar{width:64px;height:64px;border-radius:8px;object-fit:cover;border:1px solid #eee;}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
  .muted{color:#777;font-size:13px;}
  .chip{display:inline-block;padding:6px 8px;background:#fff;border:1px solid #ffd59a;border-radius:16px;margin:4px 4px 0 0;}
  .file-preview{max-width:120px;border-radius:8px;border:1px solid #eee;display:block;margin-top:8px;}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  footer{font-size:13px;color:#666;margin-top:12px;}
</style>
</head>
<body>

<h1>â˜€ï¸ã²ãªãŸã¼ã£ã“â˜€ï¸ ãƒ•ãƒ«æ©Ÿèƒ½ãƒ‡ãƒ¢</h1>

<div class="section two-col">
  <div class="col">
    <h2>ğŸ” ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²</h2>
    <div id="auth-area">
      <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆè‹±æ•°å­—ï¼‰<input type="text" id="auth-username" placeholder="ä¾‹ï¼šsakura"></label>
      <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰<input type="password" id="auth-password" placeholder="ï¼ˆç°¡æ˜“ä¿å­˜ï¼‰"></label>
      <div class="controls">
        <button class="btn" id="btn-register">æ–°è¦ç™»éŒ² & ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å…¥åŠ›ã¸</button>
        <button class="btn" id="btn-login">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button class="btn" id="btn-logout" style="display:none;background:#888">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
      <div id="auth-msg" class="small"></div>
    </div>

    <hr>

    <div id="my-profile-section" style="display:none;">
      <h2>ğŸ§¾ ã‚ãªãŸã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h2>
      <label>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ <input type="text" id="pf-nickname"></label>
      <label>æ€§åˆ¥
        <select id="pf-gender">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="å¥³æ€§">å¥³æ€§</option>
          <option value="ç”·æ€§">ç”·æ€§</option>
          <option value="ãã®ä»–">ãã®ä»–</option>
        </select>
      </label>
      <label>å¹´é½¢<input type="number" id="pf-age" min="18" max="120"></label>
      <label>å±…ä½åœ°<input type="text" id="pf-residence"></label>
      <label>è¶£å‘³ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰<input type="text" id="pf-hobbies" placeholder="ä¾‹ï¼šã‚«ãƒ•ã‚§,æ—…è¡Œ,å†™çœŸ"></label>
      <label>ä¸€è¨€ï¼ˆæ¤œç´¢ã‚«ãƒ¼ãƒ‰ã«è¡¨ç¤ºï¼‰<input type="text" id="pf-oneline"></label>
      <label>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è©³ç´°<textarea id="pf-text" rows="3"></textarea></label>
      <label>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†™çœŸï¼ˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰<input type="file" id="pf-photo" accept="image/*"></label>
      <img id="pf-photo-preview" class="file-preview" style="display:none;">
      <div class="controls">
        <button class="btn" id="btn-save-profile">ä¿å­˜ã—ã¦è¡¨ç¤º</button>
        <button class="btn" id="btn-delete-account" style="background:#c14">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰</button>
      </div>
      <div class="small">â€»å†™çœŸã¯ãƒ–ãƒ©ã‚¦ã‚¶ã® localStorage ã«ãƒ‡ãƒ¼ã‚¿URLå½¢å¼ã§ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆã‚µã‚¤ã‚ºæ³¨æ„ï¼‰</div>
    </div>

    <hr>

    <div>
      <h2>ğŸ” æ¤œç´¢</h2>
      <label>åå‰ã§æ¤œç´¢<input type="text" id="search-name" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›"></label>
      <label>å¹´é½¢ç¯„å›² <input type="number" id="age-min" placeholder="æœ€å°" style="width:48%;"> ã€œ <input type="number" id="age-max" placeholder="æœ€å¤§" style="width:48%;"></label>
      <label>å±…ä½åœ°<input type="text" id="search-residence" placeholder="ä¾‹ï¼šæ±äº¬"></label>
      <div class="controls">
        <button class="btn" id="btn-search">æ¤œç´¢</button>
        <button class="btn" id="btn-reset-search" style="background:#aaa">ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>

  </div>

  <div class="col">
    <h2>ğŸŒ· ä¼šå“¡ä¸€è¦§</h2>
    <div id="userList"></div>

    <hr>

    <h2>ğŸ‘¤ é¸æŠä¸­ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h2>
    <div id="profileDetail" class="profile-card">ä¼šå“¡ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è©³ç´°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>

    <hr>

    <h2>ğŸ’ ãƒãƒƒãƒå±¥æ­´</h2>
    <div id="matchHistory" class="profile-card">ã¾ã ãƒãƒƒãƒã‚ã‚Šã¾ã›ã‚“</div>

    <hr>

    <h2>ğŸ’¬ ãƒãƒ£ãƒƒãƒˆ (<span id="chatPartner">æœªé¸æŠ</span>)</h2>
    <div id="chat" aria-live="polite"></div>
    <div style="margin-top:8px;display:flex;gap:8px;">
      <input type="text" id="chatInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›" style="flex:1;padding:8px;border-radius:6px;border:1px solid #ddd;">
      <button class="btn" id="btn-send">é€ä¿¡</button>
    </div>

  </div>
</div>

<div class="section">
  <h2>â˜€ï¸ ãƒ‡ãƒ¼ãƒˆè©•ä¾¡ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§ä¿å­˜ï¼‰</h2>
  <div id="ratingsArea" class="grid"></div>
  <div id="ratingResult" class="small" style="margin-top:8px;"></div>
</div>

<!-- ãƒãƒƒãƒãƒãƒƒãƒ— -->
<div id="matchPopupHolder"></div>

<footer>ã“ã®ãƒ‡ãƒ¢ã¯ localStorage ã‚’åˆ©ç”¨ã—ãŸæ“¬ä¼¼çš„ãªå®Ÿè£…ã§ã™ã€‚å®Ÿé‹ç”¨ã«ã¯ã‚µãƒ¼ãƒãƒ¼å´ã®èªè¨¼ãƒ»ä¿å­˜ãŒå¿…è¦ã§ã™ã€‚</footer>

<script>
/* ====== ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆå®‰å…¨å–å¾—ï¼‰ ====== */
function safeGet(id){ return document.getElementById(id) || null; }
function uid(name){ return (name||'').toLowerCase().replace(/\s+/g,'_'); }

/* ====== ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼ ====== */
const KEY_USERS = 'hinata_users_v1';       // ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ï¼ˆé…åˆ—ï¼‰
const KEY_CURRENT = 'hinata_current_v1';   // ç¾åœ¨ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
const KEY_CHATS = 'hinata_chats_v1';       // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
const KEY_LIKES = 'hinata_likes_v1';       // ã„ã„ã­æƒ…å ±
const KEY_MATCHES = 'hinata_matches_v1';   // ãƒãƒƒãƒä¸€è¦§ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ID->é…åˆ—ï¼‰
const KEY_RATINGS = 'hinata_ratings_v1';   // è©•ä¾¡ä¿å­˜
const KEY_PHOTOS = 'hinata_photos_v1';     // å†™çœŸä¿å­˜ map id->dataURL

/* ====== åˆæœŸãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ€ãƒŸãƒ¼ä¼šå“¡ãƒ»ä¾‹ï¼‰ ====== */
function seedDummy(){
  if(localStorage.getItem(KEY_USERS)) return;
  const dummy = [
    {id:'yui', user:'yui', pw:'pass', nickname:'çµè¡£', gender:'å¥³æ€§', age:25, residence:'æ±äº¬', hobbies:['ã‚«ãƒ•ã‚§','å†™çœŸ'], oneline:'ã‚«ãƒ•ã‚§ã¨çŒ«ãŒå¥½ãâ˜•ğŸ±', text:'ã‚«ãƒ•ã‚§å·¡ã‚ŠãŒå¥½ãã§ã™ã€‚ã®ã‚“ã³ã‚Šã—ãŸæ™‚é–“ã‚’ä¸€ç·’ã«éã”ã›ã‚‹æ–¹ã«ä¼šã„ãŸã„ã§ã™ã€‚'},
    {id:'mizuki', user:'mizuki', pw:'pass', nickname:'ç¾æœˆ', gender:'å¥³æ€§', age:31, residence:'åŒ—æµ·é“', hobbies:['æ¸©æ³‰','æ—…è¡Œ'], oneline:'è‡ªç„¶ã¨æ¸©æ³‰ã§ãƒªãƒ©ãƒƒã‚¯ã‚¹â™¨ï¸', text:'é€±æœ«ã¯æ¸©æ³‰ã§ã‚†ã£ãŸã‚Šã€‚ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢ã‚‚å¥½ãã§ã™ã€‚'},
    {id:'shota', user:'shota', pw:'pass', nickname:'ç¿”å¤ª', gender:'ç”·æ€§', age:29, residence:'ç¥å¥ˆå·', hobbies:['ã‚¹ãƒãƒ¼ãƒ„','ç­‹ãƒˆãƒ¬'], oneline:'é‹å‹•å¤§å¥½ãï¼', text:'ã‚¹ãƒãƒ¼ãƒ„è¦³æˆ¦ã‚„ä¸€ç·’ã«ä½“ã‚’å‹•ã‹ã™ã®ãŒå¥½ãã§ã™ã€‚'},
    {id:'daiki', user:'daiki', pw:'pass', nickname:'å¤§è¼', gender:'ç”·æ€§', age:27, residence:'å¤§é˜ª', hobbies:['æ–™ç†','æ—…è¡Œ'], oneline:'æ–™ç†ç”·å­ã§ã™ğŸ³', text:'å®¶åº­çš„ãªæ™‚é–“ãŒå¥½ãã€‚ç¾å‘³ã—ã„ã‚‚ã®ã‚’ä¸€ç·’ã«ä½œã‚ŠãŸã„ã€‚'}
  ];
  localStorage.setItem(KEY_USERS, JSON.stringify(dummy));
  localStorage.setItem(KEY_LIKES, JSON.stringify({})); 
  localStorage.setItem(KEY_MATCHES, JSON.stringify({}));
  localStorage.setItem(KEY_CHATS, JSON.stringify({}));
  localStorage.setItem(KEY_RATINGS, JSON.stringify({}));
  localStorage.setItem(KEY_PHOTOS, JSON.stringify({}));
}
seedDummy();

/* ====== èªè¨¼å‘¨ã‚Šï¼ˆæ“¬ä¼¼ï¼‰ ====== */
function getUsers(){ return JSON.parse(localStorage.getItem(KEY_USERS)||'[]'); }
function saveUsers(arr){ localStorage.setItem(KEY_USERS, JSON.stringify(arr)); }

function registerUser(user, pw){
  const users = getUsers();
  if(users.find(u=>u.user===user)) return {ok:false,msg:'ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯æ—¢ã«ä½¿ã‚ã‚Œã¦ã„ã¾ã™'};
  const id = uid(user);
  users.push({id:id, user:user, pw:pw, nickname:user, gender:'', age:null, residence:'', hobbies:[], oneline:'', text:''});
  saveUsers(users);
  return {ok:true,id:id};
}

function loginUser(user, pw){
  const users = getUsers();
  const found = users.find(u=>u.user===user && u.pw===pw);
  if(!found) return {ok:false,msg:'ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™'};
  localStorage.setItem(KEY_CURRENT, found.id);
  loadCurrentProfileToForm();
  return {ok:true,id:found.id};
}

function logout(){
  localStorage.removeItem(KEY_CURRENT);
  safeGet('btn-logout').style.display='none';
  safeGet('auth-msg').textContent='ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ';
  // hide profile area
  safeGet('my-profile-section').style.display='none';
}

/* ====== UI åˆæœŸåŒ– / è¡¨ç¤ºç³» ====== */
function currentUserId(){ return localStorage.getItem(KEY_CURRENT) || null; }

function getPhotos(){ return JSON.parse(localStorage.getItem(KEY_PHOTOS)||'{}'); }
function savePhotoMap(m){ localStorage.setItem(KEY_PHOTOS, JSON.stringify(m)); }

function getChats(){ return JSON.parse(localStorage.getItem(KEY_CHATS)||'{}'); }
function saveChats(obj){ localStorage.setItem(KEY_CHATS, JSON.stringify(obj)); }

function getLikes(){ return JSON.parse(localStorage.getItem(KEY_LIKES)||'{}'); }
function saveLikes(obj){ localStorage.setItem(KEY_LIKES, JSON.stringify(obj)); }

function getMatches(){ return JSON.parse(localStorage.getItem(KEY_MATCHES)||'{}'); }
function saveMatches(obj){ localStorage.setItem(KEY_MATCHES, JSON.stringify(obj)); }

function getRatings(){ return JSON.parse(localStorage.getItem(KEY_RATINGS)||'{}'); }
function saveRatings(obj){ localStorage.setItem(KEY_RATINGS, JSON.stringify(obj)); }

function renderUserList(filterObj){
  const container = safeGet('userList');
  container.innerHTML='';
  const users = getUsers();
  users.forEach(u=>{
    // skip if no user data? show all for now
    // filter checks
    if(filterObj){
      if(filterObj.name && !u.nickname.includes(filterObj.name)) return;
      if(filterObj.residence && !u.residence.includes(filterObj.residence)) return;
      if(filterObj.minAge && (u.age===null || u.age<filterObj.minAge)) return;
      if(filterObj.maxAge && (u.age===null || u.age>filterObj.maxAge)) return;
    }
    const div = document.createElement('div');
    div.className='profile-card';
    // photo if any
    const photos = getPhotos();
    const photoHtml = photos[u.id] ? `<img src="${photos[u.id]}" class="avatar" alt="photo">` : `<div style="width:64px;height:64px;border-radius:8px;background:#fff;border:1px solid #eee;display:inline-block;text-align:center;line-height:64px;color:#999;margin-right:8px;">No</div>`;
    div.innerHTML=`
      <div style="display:flex;gap:8px;align-items:center;">
        ${photoHtml}
        <div style="flex:1;">
          <strong>${u.nickname || u.user}</strong> <span class="muted">(${u.age||'å¹´é½¢æœªè¨­å®š'})</span><br>
          <span class="muted">${u.residence || ''}</span><br>
          <span class="small">${u.oneline || ''}</span>
        </div>
      </div>
      <div style="margin-top:8px;">
        <button class="btn" onclick='showDetail("${u.id}")'>è©³ç´°</button>
        <button class="btn" onclick='doLike("${u.id}")' style="background:#ffb74d">ã„ã„ã­</button>
      </div>
    `;
    container.appendChild(div);
  });
}

/* ====== è©³ç´°è¡¨ç¤ºï¼ˆã‚¯ãƒªãƒƒã‚¯ã§ï¼‰ ====== */
function showDetail(id){
  const users = getUsers();
  const u = users.find(x=>x.id===id);
  if(!u) return;
  const photos = getPhotos();
  const photoHtml = photos[id] ? `<img src="${photos[id]}" class="file-preview">` : '';
  safeGet('profileDetail').innerHTML = `
    <div style="display:flex;gap:12px;align-items:center;">
      ${photoHtml}
      <div>
        <h3 style="margin:0">${u.nickname || u.user}</h3>
        <div class="muted">${u.gender||''} ãƒ» ${u.age || ''}æ­³ ãƒ» ${u.residence||''}</div>
        <div style="margin-top:6px">${u.text||''}</div>
        <div style="margin-top:6px">
          ${ (u.hobbies||[]).map(h=>`<span class="chip">${h}</span>`).join('') }
        </div>
      </div>
    </div>
  `;
}

/* ====== ã„ã„ã­ / ãƒãƒƒãƒ ====== */
function doLike(targetId){
  const me = currentUserId();
  if(!me){ alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„'); return; }
  if(me === targetId){ alert('è‡ªåˆ†ã«ã¯ã„ã„ã­ã§ãã¾ã›ã‚“'); return; }
  const likes = getLikes();
  likes[me] = likes[me]||[];
  if(!likes[me].includes(targetId)) likes[me].push(targetId);
  saveLikes(likes);

  // ãƒãƒƒãƒåˆ¤å®šï¼šç›¸æ‰‹ãŒæ—¢ã«ã‚ãªãŸã«ã„ã„ã­ã—ã¦ã„ã‚‹ã‹
  if(likes[targetId] && likes[targetId].includes(me)){
    // match!
    const matches = getMatches();
    matches[me] = matches[me]||[];
    matches[targetId] = matches[targetId]||[];
    if(!matches[me].includes(targetId)) matches[me].push(targetId);
    if(!matches[targetId].includes(me)) matches[targetId].push(me);
    saveMatches(matches);
    showMatchPopup(targetId);
    renderMatches(); // æ›´æ–°
  } else {
    alert('ã„ã„ã­ã—ã¾ã—ãŸ');
  }
}

/* ====== ãƒãƒƒãƒæ¼”å‡ºãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— ====== */
function showMatchPopup(otherId){
  const users = getUsers();
  const u = users.find(x=>x.id===otherId);
  const holder = safeGet('matchPopupHolder');
  const popup = document.createElement('div');
  popup.className='match-popup';
  popup.innerHTML = `
    <div style="display:flex;gap:12px;align-items:center;">
      <div style="font-size:28px">âœ¨</div>
      <div>
        <strong>ãƒãƒƒãƒã—ã¾ã—ãŸï¼</strong><br>
        ${u ? u.nickname : otherId} ã•ã‚“ã¨ãƒãƒƒãƒã§ã™ğŸ’
        <div style="margin-top:8px;">
          <button class="btn" onclick="openChatWith('${otherId}');closePopup(this)">ãƒãƒ£ãƒƒãƒˆã‚’å§‹ã‚ã‚‹</button>
          <button class="btn" style="background:#aaa" onclick="closePopup(this)">é–‰ã˜ã‚‹</button>
        </div>
      </div>
    </div>
  `;
  holder.appendChild(popup);
  // è‡ªå‹•ã§æ¶ˆãˆã‚‹ï¼ˆ3.5ç§’ï¼‰
  setTimeout(()=>{ if(popup.parentNode) popup.parentNode.removeChild(popup); }, 3500);
}
function closePopup(el){ const p = el.closest('.match-popup'); if(p && p.parentNode) p.parentNode.removeChild(p); }

/* ====== ãƒãƒƒãƒå±¥æ­´è¡¨ç¤ºï¼ˆã‚¯ãƒªãƒƒã‚¯ã§ãƒãƒ£ãƒƒãƒˆç›¸æ‰‹é¸æŠï¼‰ ====== */
function renderMatches(){
  const me = currentUserId();
  const box = safeGet('matchHistory');
  if(!box) return;
  const matches = getMatches();
  box.innerHTML = '';
  if(!me || !matches[me] || matches[me].length===0){
    box.innerHTML = 'ã¾ã ãƒãƒƒãƒãŒã‚ã‚Šã¾ã›ã‚“';
    return;
  }
  matches[me].forEach(id=>{
    const users = getUsers();
    const u = users.find(x=>x.id===id);
    const div = document.createElement('div');
    div.className = 'profile-card';
    div.innerHTML = `<strong>${u ? u.nickname : id}</strong> 
      <div style="margin-top:6px;">
        <button class="btn" onclick='openChatWith("${id}")'>ãƒãƒ£ãƒƒãƒˆ</button>
        <button class="btn" style="background:#aaa" onclick='showDetail("${id}")'>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</button>
      </div>`;
    box.appendChild(div);
  });
}

/* ====== ãƒãƒ£ãƒƒãƒˆå±¥æ­´ç›¸æ‰‹åˆ¥ä¿å­˜ ====== */
function chatsKey(a,b){ // normalized key
  const [x,y] = [a,b].sort();
  return `${x}__${y}`;
}
function openChatWith(otherId){
  const me = currentUserId();
  if(!me){ alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„'); return; }
  currentPartner = otherId;
  safeGet('chatPartner').textContent = (getUsers().find(u=>u.id===otherId)?.nickname || otherId);
  renderChat();
}
function renderChat(){
  const me = currentUserId();
  const partner = currentPartner;
  const chatDiv = safeGet('chat');
  chatDiv.innerHTML='';
  if(!me || !partner) return;
  const key = chatsKey(me, partner);
  const all = getChats();
  const arr = all[key] || [];
  arr.forEach(m=>{
    const p = document.createElement('p');
    p.innerHTML = `<strong>${m.from === me ? 'ã‚ãªãŸ' : (getUsers().find(u=>u.id===m.from)?.nickname || m.from)}:</strong> ${escapeHtml(m.text)} <span class="muted" style="font-size:12px">(${new Date(m.ts).toLocaleString()})</span>`;
    chatDiv.appendChild(p);
  });
  chatDiv.scrollTop = chatDiv.scrollHeight;
}
function sendChatMessage(){
  const me = currentUserId();
  const partner = currentPartner;
  const inp = safeGet('chatInput');
  if(!me || !partner){ alert('ãƒãƒ£ãƒƒãƒˆç›¸æ‰‹ã‚’é¸ã‚“ã§ãã ã•ã„'); return; }
  const text = inp.value.trim();
  if(!text) return;
  const key = chatsKey(me, partner);
  const all = getChats();
  all[key] = all[key] || [];
  all[key].push({from:me, text:text, ts:Date.now()});
  saveChats(all);
  inp.value='';
  renderChat();
}
safeGet('btn-send').addEventListener('click', sendChatMessage);

/* ====== è©•ä¾¡ï¼ˆâ˜€ï¸ã‚¯ãƒªãƒƒã‚¯ã§ä¿å­˜ï¼†è¡¨ç¤ºï¼‰ ====== */
const ratingItems = ["æ¥½ã—ã•","æ¸…æ½”æ„Ÿãƒ»èº«ã ã—ãªã¿","æ™‚é–“å³å®ˆ","æ°—é£ã„ãƒ»ãƒãƒŠãƒ¼","é›°å›²æ°—","ç·åˆçš„ã«"];
function buildRatingsUI(){
  const area = safeGet('ratingsArea');
  area.innerHTML='';
  ratingItems.forEach(item=>{
    const div = document.createElement('div');
    div.innerHTML = `<strong>${item}</strong><br>`;
    for(let i=1;i<=5;i++){
      const s = document.createElement('span');
      s.className='sun';
      s.textContent='â˜€ï¸';
      s.dataset.item = item;
      s.dataset.val = i;
      s.onclick = ()=>{ setRating(item,i); };
      div.appendChild(s);
    }
    area.appendChild(div);
  });
}
function setRating(item,val){
  const me = currentUserId();
  if(!me){ alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„'); return; }
  const all = getRatings();
  all[me] = all[me] || {};
  all[me][item] = val;
  saveRatings(all);
  updateRatingView();
}
function updateRatingView(){
  const me = currentUserId();
  const out = safeGet('ratingResult');
  if(!me) { out.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨è©•ä¾¡ã‚’ä¿å­˜ã§ãã¾ã™'; return; }
  const all = getRatings();
  const mine = all[me] || {};
  let html='';
  ratingItems.forEach(it=>{
    if(mine[it]) html += `${it}ï¼š${'â˜€ï¸'.repeat(mine[it])} (${mine[it]})\n`;
  });
  out.textContent = html || 'ã¾ã è©•ä¾¡ãŒã‚ã‚Šã¾ã›ã‚“';
}
buildRatingsUI();
updateRatingView();

/* ====== ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆdataURLï¼‰ ====== */
safeGet('pf-photo').addEventListener('change', (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = function(ev){
    safeGet('pf-photo-preview').src = ev.target.result;
    safeGet('pf-photo-preview').style.display='block';
    // temporarily keep in memory; saved on profile save
    safeGet('pf-photo-preview').dataset.tmp = ev.target.result;
  };
  reader.readAsDataURL(f);
});

/* ====== ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜ & å¾©å…ƒ ====== */
function saveProfileForCurrent(){
  const me = currentUserId();
  if(!me) { alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„'); return; }
  const users = getUsers();
  const u = users.find(x=>x.id===me);
  if(!u) return;
  u.nickname = safeGet('pf-nickname').value || u.nickname || u.user;
  u.gender = safeGet('pf-gender').value || u.gender;
  u.age = parseInt(safeGet('pf-age').value) || u.age;
  u.residence = safeGet('pf-residence').value || u.residence;
  u.hobbies = (safeGet('pf-hobbies').value || '').split(',').map(s=>s.trim()).filter(Boolean);
  u.oneline = safeGet('pf-oneline').value || u.oneline;
  u.text = safeGet('pf-text').value || u.text;
  // photo
  const preview = safeGet('pf-photo-preview');
  if(preview && preview.dataset.tmp){
    const photos = getPhotos();
    photos[me] = preview.dataset.tmp;
    savePhotoMap(photos);
    delete preview.dataset.tmp;
  }
  saveUsers(users);
  alert('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
  renderUserList(); showDetail(me); renderMatches(); updateRatingView();
}

/* ====== register/login button events ====== */
safeGet('btn-register').addEventListener('click', ()=>{
  const u = safeGet('auth-username').value.trim();
  const p = safeGet('auth-password').value;
  if(!u || !p){ alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const r = registerUser(u,p);
  if(!r.ok){ alert(r.msg); return; }
  localStorage.setItem(KEY_CURRENT, r.id);
  safeGet('auth-msg').textContent = 'ç™»éŒ²ã—ã¾ã—ãŸã€‚ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
  safeGet('btn-logout').style.display='inline-block';
  safeGet('my-profile-section').style.display='block';
  loadCurrentProfileToForm();
  renderUserList();
  renderMatches();
});
safeGet('btn-login').addEventListener('click', ()=>{
  const u = safeGet('auth-username').value.trim();
  const p = safeGet('auth-password').value;
  if(!u || !p){ alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const r = loginUser(u,p);
  if(!r.ok){ alert(r.msg); return; }
  safeGet('auth-msg').textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ';
  safeGet('btn-logout').style.display='inline-block';
  safeGet('my-profile-section').style.display='block';
  renderUserList(); renderMatches(); updateRatingView();
});
safeGet('btn-logout').addEventListener('click', ()=>{
  logout();
  renderUserList(); renderMatches(); updateRatingView();
});

/* ====== åˆæœŸè¡¨ç¤º / èµ·å‹•æ™‚å¾©å…ƒ ====== */
function loadCurrentProfileToForm(){
  const me = currentUserId();
  if(!me) return;
  const users = getUsers();
  const u = users.find(x=>x.id===me);
  if(!u) return;
  safeGet('pf-nickname').value = u.nickname || '';
  safeGet('pf-gender').value = u.gender || '';
  safeGet('pf-age').value = u.age || '';
  safeGet('pf-residence').value = u.residence || '';
  safeGet('pf-hobbies').value = (u.hobbies||[]).join(',');
  safeGet('pf-oneline').value = u.oneline || '';
  safeGet('pf-text').value = u.text || '';
  const photos = getPhotos();
  if(photos[me]){
    safeGet('pf-photo-preview').src = photos[me];
    safeGet('pf-photo-preview').style.display='block';
  } else {
    safeGet('pf-photo-preview').style.display='none';
  }
}

safeGet('btn-save-profile').addEventListener('click', saveProfileForCurrent);

/* ====== ã‚µãƒ¼ãƒãƒœã‚¿ãƒ³ / ãƒªã‚»ãƒƒãƒˆ ====== */
safeGet('btn-search').addEventListener('click', ()=>{
  const name = safeGet('search-name').value.trim();
  const min = parseInt(safeGet('age-min').value) || null;
  const max = parseInt(safeGet('age-max').value) || null;
  const res = safeGet('search-residence').value.trim();
  renderUserList({name:name || null, minAge:min, maxAge:max, residence:res || null});
});
safeGet('btn-reset-search').addEventListener('click', ()=>{
  safeGet('search-name').value=''; safeGet('age-min').value=''; safeGet('age-max').value=''; safeGet('search-residence').value='';
  renderUserList();
});

/* ====== ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰ ====== */
safeGet('btn-delete-account').addEventListener('click', ()=>{
  const me = currentUserId();
  if(!me){ alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„'); return; }
  if(!confirm('æœ¬å½“ã«ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆlocalStorageå†…ã®ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆã¾ã™ï¼‰')) return;
  let users = getUsers().filter(u=>u.id!==me);
  saveUsers(users);
  // remove photos, likes, matches, chats, ratings entries for me
  let photos = getPhotos(); delete photos[me]; savePhotoMap(photos);
  let likes = getLikes(); delete likes[me]; saveLikes(likes);
  let matches = getMatches(); delete matches[me]; for(const k in matches) matches[k] = matches[k].filter(x=>x!==me); saveMatches(matches);
  let chats = getChats(); for(const k in chats){ if(k.includes(me)) delete chats[k]; } saveChats(chats);
  let ratings = getRatings(); delete ratings[me]; saveRatings(ratings);
  localStorage.removeItem(KEY_CURRENT);
  alert('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
  renderUserList(); renderMatches(); updateRatingView();
});

/* ====== åˆæœŸãƒ¬ãƒ³ãƒ€ãƒ¼ ====== */
(function init(){
  // restore login if exists
  if(currentUserId()){
    safeGet('my-profile-section').style.display='block';
    safeGet('btn-logout').style.display='inline-block';
    loadCurrentProfileToForm();
  } else {
    safeGet('my-profile-section').style.display='none';
  }
  renderUserList();
  renderMatches();
  updateRatingView();
})();

/* ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====== */
function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

</script>
</body>
</html>
